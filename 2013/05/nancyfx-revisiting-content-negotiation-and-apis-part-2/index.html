<!DOCTYPE html>
<html dir="ltr" lang="en-US">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <meta http-equiv="last-modified" content="2014-02-07T01:05:41.3846003+08:00" />
    <title>philliphaydon.com</title>
    <link rel="stylesheet" type="text/css" href="/stylesheets/style.css" />
    <link rel="canonical" href="http://www.philliphaydon.com/2013/05/nancyfx-revisiting-content-negotiation-and-apis-part-2/" />
</head>
<body class="home blog">
    <div id="page" class="hfeed site">
        <header id="masthead" class="site-header fancy-container lightgreen" role="banner">
            <hgroup>
                <h1 class="site-title"><a href="/" title="philliphaydon.com" rel="home">philliphaydon.com</a></h1>
                <h2><small>Works on my PC...</small></h2>
                <p class="site-description">Pleb from New Zealand who was banished overseas and currently resides in Singapore.</p>
            </hgroup>
            <nav role="navigation" class="site-navigation main-navigation">
                <h1 class="assistive-text">Menu</h1>
                <div class="assistive-text skip-link"><a href="#content" title="Skip to content">Skip to content</a></div>
                <div class="menu">
                    <ul>
                        <li><a href="/about">About</a></li>
                        <li><a href="/category">Categories</a></li>
                        <li><a href="/archive">Archive</a></li>
                        <li><a href="/feed.xml">RSS / Feed</a></li>
                    </ul>
                </div>
            </nav>
        </header>
        <div id="main">
            <div id="primary" class="site-content">
                <div id="content" role="main">
                  

<div id="post">
    <h1>NancyFX - Revisiting Content Negotiation &amp; APIs (Part 2)</h1>

    <div class="post-note">
      posted on 09 May 2013
       | <a href="/category/nancyfx">NancyFX</a>
      
      <div class="addthis_toolbox addthis_default_style" style="float:right;">
        <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
        <a class="addthis_button_tweet"></a>
        <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
        <a class="addthis_button_linkedin_counter"></a>
        <a class="addthis_counter addthis_pill_style"></a>
      </div>
    </div>
    
    
        
    <ul>
<li>Original Post: <a href="/2012/11/nancy-and-content-negotiation">NancyFX and Content Negotiation</a></li>
<li><a href="/2013/04/nancyfx-revisiting-content-negotiation-and-apis-part-1/">NancyFX - Revisiting Content Negotiation &amp; APIs (Part 1)</a></li>
<li>NancyFX - Revisiting Content Negotiation &amp; APIs (Part 2)</li>
<li><a href="/2013/05/nancyfx-revisiting-content-negotiation-and-apis-part-3/">NancyFX - Revisiting Content Negotiation &amp; APIs (Part 3)</a></li>
</ul>

<p>In part 1 I went over a really basic scenario, and one of the fiddly things we had was the view name for returning a collection.</p>

<p>Using <code>Negotiate</code> gives as more flexibility on what we can return, allowing us to customize the response to respond differently to different media types or returning partial content in some scenarios.</p>

<p>Going back to my previous post I said we should be able to use the same API to build our website as we expose. But what about when we want to have additional information on the website that isn't pushed out to the client.</p>

<p>Lets say you have a product catalog, and you can view a particular product on your website. You also allow people to pull the content from your site to display on their website as like an affiliate system of some sort. But when you render your product you may have a special, but when you send the product to the consuming client you don't want to include the special for them since it's something specific to your website.</p>

<h2>Show me the codez!</h2>

<p>So lets update the <code>Product</code> to include <code>SpecialPrice</code></p>

<!--excerpt-->

<pre><code>public class Product
{
    public int Id { get; set; }
    public string Name { get; set; }
    public decimal Price { get; set; }
    public decimal? SpecialPrice { get; set; }
}
</code></pre>

<p><strong><em>Note:</strong> and also update the repository to return the Special Price on each <code>Product</code></em></p>

<p>We're also going to introduce a new model called <code>PartialProduct</code>. There may be a better name for it, but its what I picked for the purpose of demonstrating. This is going to be the same as <code>Product</code> but without the <code>SpecialPrice</code> property.</p>

<pre><code>public class PartialProduct
{
    public PartialProduct()
    {
    }

    public PartialProduct(Product product)
    {
        Id = product.Id;
        Name = product.Name;
        Price = product.Price;
    }

    public int Id { get; set; }
    public string Name { get; set; }
    public decimal Price { get; set; }
}
</code></pre>

<p>The constructor is used to populate the model based on a <code>Product</code>. You may want to use something like AutoMapper to do this for you, or write some extension methods, etc.</p>

<p>Now with our route, we want to return the <code>PartialProduct</code> when responding to <code>application/json</code> or <code>application/xml</code></p>

<pre><code>Get["/{id}"] = _ =&gt;
{
    var product = productRepository.Get((int)_.id);

    return Negotiate.WithView("product")
                    .WithModel(product)
                    .WithMediaRangeModel(MediaRange.FromString("application/json"),
                                         new PartialProduct(product))
                    .WithMediaRangeModel(MediaRange.FromString("application/xml"),
                                         new PartialProduct(product));
};
</code></pre>

<p>So we are saying that we want to negotiate the response with the view <code>product</code> using the model <code>product</code>, but if the MediaRange is <code>application/json</code> we want to return a partial product, likewise if its <code>application/xml</code> we want to also return a partial model. <em>(if it looks like a lot to type, don't worry we can tidy this up)</em></p>

<p>Now when we setup our Postman looking for <code>text/html</code> we get the <code>SpecialPrice</code> returned on the product:</p>

<p><img src="/images/nancyfx-conneg-updated-part2-1.png" alt="" /></p>

<p>However if we update it to <code>application/json</code> we get:</p>

<p><img src="/images/nancyfx-conneg-updated-part2-2.png" alt="" /></p>

<p>Anddddd <code>application/xml</code> we get:</p>

<p><img src="/images/nancyfx-conneg-updated-part2-3.png" alt="" /></p>

<p>But... We kinda had to write a lot of code for the media ranges. Extension methods are awesome though, so we can tidy them up by introducing our own extension methods:</p>

<pre><code>public static class NegotiateExtensions
{
    public static Negotiator ForJson(this Negotiator negotiator, object model)
    {
        return negotiator.WithMediaRangeModel(MediaRange.FromString("application/json"), model);
    }

    public static Negotiator ForXml(this Negotiator negotiator, object model)
    {
        return negotiator.WithMediaRangeModel(MediaRange.FromString("application/xml"), model);
    }
}   
</code></pre>

<p>This reduces things down to:</p>

<pre><code>Get["/{id}"] = _ =&gt;
{
    var product = productRepository.Get((int)_.id);

    return Negotiate.WithView("product")
                    .WithModel(product)
                    .ForJson(new PartialProduct(product))
                    .ForXml(new PartialProduct(product));
};
</code></pre>

<p>Still too much? We can introduce one more extension</p>

<pre><code>public static Negotiator OrPartial(this Negotiator negotiator, object model)
{
    return negotiator.ForJson(model).ForXml(model);
}
</code></pre>

<p>And now all we have is</p>

<pre><code>Get["/{id}"] = _ =&gt;
{
    var product = productRepository.Get((int)_.id);

    return Negotiate.WithView("product")
                    .WithModel(product)
                    .OrPartial(new PartialProduct(product));
};
</code></pre>

<p>Obviously you can play around to figure out what suits you. But this gives us the flexibility to customize outputs for different media types. </p>

<p>In part 3 I'll discuss implementing your own Media Type :)</p>


    <div id="disqus_thread"></div>
<script>
    var reset_disqus = function(){
        DISQUS.reset({
            reload: true,
            config: function () {
                //this.page.identifier = '';
                this.page.url = 'http://www.philliphaydon.com/2013/05/nancyfx-revisiting-content-negotiation-and-apis-part-2/';
                //this.page.title = '';
            }
        });
    };

    var disqus_shortname = 'philliphaydon';
    var disqus_url = 'http://www.philliphaydon.com/2013/05/nancyfx-revisiting-content-negotiation-and-apis-part-2/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    window.addEventListener('orientationchange', reset_disqus);
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-51ca97356d8c1454"></script>

</div>
                </div>
                <!-- #content -->
            </div>
            <!-- #primary .site-content -->

            <div id="secondary" class="widget-area fancy-container lightred" role="complementary">
                <aside id="text-5" class="widget widget_text">
                    <h1 class="widget-title">Follow</h1>
                    <div class="textwidget logos">
                        <a href="https://twitter.com/philliphaydon" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://twitter.com']);"><img src="/stylesheets/images/twitter.png"></a>
                        <a href="http://stackoverflow.com/users/456813/phill" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://stackoverflow.com']);"><img src="/stylesheets/images/stackoverflow.png"></a>
                        <a href="http://www.linkedin.com/in/philliphaydon" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://www.linkedin.com']);"><img src="/stylesheets/images/linkedin.png"></a>
                        <a href="https://plus.google.com/u/0/111751877537461442095" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://plus.google.com']);"><img src="/stylesheets/images/googleplus.png"></a>
                        <a href="https://coderbits.com/philliphaydon" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','https://coderbits.com/philliphaydon']);"><img src="/stylesheets/images/codebits.png"></a>
                        <a href="https://github.com/phillip-haydon" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://github.com']);"><img src="/stylesheets/images/github.png"></a>
                        <a href="http://www.codeschool.com/users/philliphaydon" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://codeschool.com']);"><img src="/stylesheets/images/codeschool.png"></a>
                        <a href="http://www.kickstarter.com/profile/phillip-haydon" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://kickstarter.com']);"><img src="/stylesheets/images/kickstarter.png"></a>
                    </div>
                    <a href="http://stackoverflow.com/users/456813/phill">
                      <img src="http://stackoverflow.com/users/flair/456813.png" width="208" height="58" alt="profile for Phill at Stack Overflow, Q&amp;A for professional and enthusiast programmers" title="profile for Phill at Stack Overflow, Q&amp;A for professional and enthusiast programmers">
                    </a>
                    
                    <a href="http://nancyfx.org/mvm.html"><img src="/stylesheets/images/mvm.png"></a>
                    
                    <div id = "clustrback" style="width:162px; height:133px;  background:#f7f7f7 url(http://clustrmaps.com/admin/3d/images/st4_grey.png)  center no-repeat; text-align:center;">
                      <a href="http://www2.clustrmaps.com/counter/maps.php?url=http://www.philliphaydon.com/" style="width:160px; display:block; margin:0 auto;" id="clustrMapsLink">
                        <img src="http://www2.clustrmaps.com/counter/index2.php?url=http://www.philliphaydon.com/" style="border:0px; margin:15px auto;margin:15px auto;" alt="Locations of visitors to this page" title="Locations of visitors to this page" id="clustrMapsImg" />
                      </a>
                    </div>
                </aside>
                <!--aside id="text-8" class="widget widget_text">
                    <h1 class="widget-title">Other sites</h1>
                    <div class="textwidget">
                        <a href="http://csharptube.com/" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://csharptube.com']);">csharptube.com</a><br />
                        <a href="http://thisisparrot.com/" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://thisisparrot.com']);">Parrot</a><br />
                        <a href="http://shitprogrammerswrite.com/" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://shitprogrammerswrite.com']);">Shit programmers write</a><br />
                    </div>
                </aside-->
                <aside id="linkcat-6" class="widget widget_links">
                    <h1 class="widget-title">Other Blogs</h1>
                    <ul class='xoxo blogroll'>
                        <li><a href="http://www.nickharris.net/" target="_top" onclick="javascript:_gaq.push(['_trackEvent','outbound-blogroll','http://nickharris.net/']);">Nick Harris</a></li>
                        <li><a href="http://www.mindscapehq.com/blog/" target="_top" onclick="javascript:_gaq.push(['_trackEvent','outbound-blogroll','http://www.mindscapehq.com/blog/']);">Mindscape</a></li>
                        <li><a href="http://blog.orangelightning.co.uk/" target="" onclick="javascript:_gaq.push(['_trackEvent','outbound-blogroll','http://blog.orangelightning.co.uk/']);">Phil Jones</a></li>
                        <li><a href="http://buildstarted.com/" target="" onclick="javascript:_gaq.push(['_trackEvent','outbound-blogroll','http://buildstarted.com']);">Ben Dornis</a></li>
                        <li><a href="http://jflood.net/" target="" onclick="javascript:_gaq.push(['_trackEvent','outbound-blogroll','http://jflood.net/']);">Jospeh Flood</a></li>
                    </ul>
                    
                </aside>
                <aside id="archives-4" class="widget widget_archive">
                    <h1 class="widget-title">Archive</h1>
                    <ul class="posts">
                          <li><a href="/archive#2014February">February, 2014</a></li>
                          <li><a href="/archive#2014January">January, 2014</a></li>
                          <li><a href="/archive#2013December">December, 2013</a></li>
                          <li><a href="/archive#2013November">November, 2013</a></li>
                          <li><a href="/archive#2013October">October, 2013</a></li>
                          <li><a href="/archive#2013September">September, 2013</a></li>
                          <li><a href="/archive#2013August">August, 2013</a></li>
                          <li><a href="/archive#2013July">July, 2013</a></li>
                          <li><a href="/archive#2013June">June, 2013</a></li>
                          <li><a href="/archive#2013May">May, 2013</a></li>
                          <li><a href="/archive#2013April">April, 2013</a></li>
                          <li><a href="/archive#2013March">March, 2013</a></li>
                          <li><a href="/archive#2013February">February, 2013</a></li>
                          <li><a href="/archive#2013January">January, 2013</a></li>
                          <li><a href="/archive#2012December">December, 2012</a></li>
                          <li><a href="/archive#2012November">November, 2012</a></li>
                          <li><a href="/archive#2012October">October, 2012</a></li>
                          <li><a href="/archive#2012September">September, 2012</a></li>
                          <li><a href="/archive#2012July">July, 2012</a></li>
                          <li><a href="/archive#2012June">June, 2012</a></li>
                          <li><a href="/archive#2012April">April, 2012</a></li>
                          <li><a href="/archive#2012March">March, 2012</a></li>
                          <li><a href="/archive#2012February">February, 2012</a></li>
                          <li><a href="/archive#2012January">January, 2012</a></li>
                          <li><a href="/archive#2011December">December, 2011</a></li>
                          <li><a href="/archive#2011November">November, 2011</a></li>
                          <li><a href="/archive#2011October">October, 2011</a></li>
                          <li><a href="/archive#2011September">September, 2011</a></li>
                          <li><a href="/archive#2011August">August, 2011</a></li>
                          <li><a href="/archive#2011July">July, 2011</a></li>
                          <li><a href="/archive#2011June">June, 2011</a></li>
                          <li><a href="/archive#2011May">May, 2011</a></li>
                          <li><a href="/archive#2011April">April, 2011</a></li>
                          <li><a href="/archive#2011March">March, 2011</a></li>
                          <li><a href="/archive#2011February">February, 2011</a></li>
                          <li><a href="/archive#2011January">January, 2011</a></li>
                          <li><a href="/archive#2010December">December, 2010</a></li>
                          <li><a href="/archive#2010November">November, 2010</a></li>
                          <li><a href="/archive#2010October">October, 2010</a></li>
                          <li><a href="/archive#2010September">September, 2010</a></li>
                          <li><a href="/archive#2009July">July, 2009</a></li>
                    </ul>
                </aside>
            </div>
            <!-- #secondary .widget-area -->


        </div>
        <!-- #main -->

        <footer id="colophon" class="site-footer" role="contentinfo">
            <div class="site-info">
                Powered by <a href="https://github.com/Sandra/Sandra.Snow" rel="generator">Sandra.Snow v1.3.0</a>.	
            </div>
            <!-- .site-info -->
        </footer>
        <!-- #colophon .site-footer -->
    </div>
    <!-- #page .hfeed .site -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script src='/javascripts/prettify.js' type='text/javascript'></script>
    
    <script type="text/javascript">
var _gaq = _gaq || [];

_gaq.push(['_setAccount', 'UA-655975-13']);
_gaq.push(['_trackPageview']);
        
(function () {
    var ga = document.createElement('script');
    ga.type = 'text/javascript';
    ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(ga, s);
})();
</script>
    
    <script type='text/javascript'>
      $(function () {
        $("pre code").parent().each(function () {
          if (!$(this).hasClass("prettyprint")) {
            $(this).addClass("prettyprint");
            a = true
          }
        });

        prettyPrint();
      });
    </script>
</body>
</html>
