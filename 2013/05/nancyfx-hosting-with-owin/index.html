<!DOCTYPE html>
<html dir="ltr" lang="en-US">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <meta http-equiv="last-modified" content="2013-07-16T02:04:41.8720387+08:00" />
    <title>philliphaydon.com</title>
    <link rel="stylesheet" type="text/css" href="/stylesheets/style.css" />
</head>
<body class="home blog">
    <div id="page" class="hfeed site">
        <header id="masthead" class="site-header fancy-container lightgreen" role="banner">
            <hgroup>
                <h1 class="site-title"><a href="/" title="philliphaydon.com" rel="home">philliphaydon.com</a></h1>
                <h2><small>Works on my PC...</small></h2>
                <p class="site-description">Pleb from New Zealand who was banished overseas and currently resides in Singapore.</p>
            </hgroup>
            <nav role="navigation" class="site-navigation main-navigation">
                <h1 class="assistive-text">Menu</h1>
                <div class="assistive-text skip-link"><a href="#content" title="Skip to content">Skip to content</a></div>
                <div class="menu">
                    <ul>
                        <li><a href="/about">About</a></li>
                        <li><a href="/category">Categories</a></li>
                        <li><a href="/archive">Archive</a></li>
                        <li><a href="/rss">RSS</a> / <a href="/feed">Atom</a></li>
                    </ul>
                </div>
            </nav>
        </header>
        <div id="main">
            <div id="primary" class="site-content">
                <div id="content" role="main">
                  

<div id="post">
    <h1>NancyFX - Hosting with OWIN</h1>

    <div class="post-note">
      posted on 29 May 2013
      
        | <a href="/category/nancyfx">NancyFX</a>
      
      
      <div class="addthis_toolbox addthis_default_style" style="float:right;">
        <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
        <a class="addthis_button_tweet"></a>
        <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
        <a class="addthis_button_linkedin_counter"></a>
        <a class="addthis_counter addthis_pill_style"></a>
      </div>
    </div>
        
    <p>By now you've probably heard of OWIN, its slowly becoming more and more popular, hell even ThoughtWorks mentioned them on their <a href="http://www.thoughtworks.com/radar">Radar</a></p>

<p>If you want to know what OWIN is, head on over to Paul Glavich's blog post on <a href="http://weblogs.asp.net/pglavich/">Owin, Katana, and getting started</a></p>

<p>The question of running NancyFX with Owin has been popping up more often lately so I figured I would show you how to get setup. </p>

<h2>Codez - Project Setup</h2>

<p>Lets start off by creating a brand new Empty Web Application:</p>

<p><img src="/images/nancyfx-owin-1.png" alt="" /></p>

<p>Once created you should get a semi long list of References...</p>

<!--excerpt-->

<p><img src="/images/nancyfx-owin-2.png" alt="" /></p>

<p>First things first, we want to trim this back to almost NOTHING! That's right, we're gonna kill more references! In fact I'm going to remove EVERYTHING except the bare minimum, so that you can add references only as you need them.</p>

<p><img src="/images/nancyfx-owin-3.png" alt="" /></p>

<p>:D looks beautiful doesn't it!</p>

<p>Next we're going to add the Nugets</p>

<ul>
<li>Nancy</li>
<li>Nancy.Owin</li>
</ul>

<p>As well as the following... <strong>BUT</strong></p>

<ul>
<li>Microsoft.Owin.Host.SystemWeb</li>
<li>Microsoft.Web.Infrastructure</li>
<li>Owin</li>
</ul>

<p>At the time of writing this, these Nugets are not available on Nuget yet. You will need to get them from the Katana CI Builds from MyGet.</p>

<p>The URL for Katana CI build is <strong><em>http://www.myget.org/F/katana/</em></strong> </p>

<p>If you don't know how to add this to Nuget, you can do this 1 of 2 ways. If you've never done it, just go <code>Tools &gt; Options &gt; Packager Manager &gt; Package Sources</code></p>

<p><img src="/images/nancyfx-owin-4.png" alt="" /></p>

<p>Click the PLUS sign, enter the <code>name</code> and <code>source</code>, and press <code>ok</code></p>

<p>Now you can install the package <code>Microsoft.Owin.Host.SystemWeb</code> by entering:</p>

<blockquote>
  <p>Install-Package Microsoft.Owin.Host.SystemWeb <strong>-pre</strong></p>
</blockquote>

<p>Make sure you have <code>-pre</code> on the end so that it pulls the pre-release packages. This will automatically install all 3 requires packages.</p>

<h2>Codez - Startup</h2>

<p>Next we need to create a Startup file, this is where we tell Owin to use the Nancy.Owin middleware, this is a assembly the Nancy Team has created which does all the hard lifting to wire up Nancy to the Owin interfaces. </p>

<p>I guess you could say this is like adding the Nancy Hanlder to the web.config file...</p>

<pre><code>&lt;handlers&gt;
    &lt;add name="Nancy" verb="*" type="Nancy.Hosting.Aspnet.NancyHttpRequestHandler" path="*" /&gt;
&lt;/handlers&gt;
</code></pre>

<p>Except now we don't need any of that! <em>(so don't go adding that to your web.config!)</em></p>

<p>If you want to dive into what the middleware is doing you can take a look at <a href="https://twitter.com/PrabirShrestha">Prabir's</a> repository here:</p>

<p><a href="https://github.com/prabirshrestha/simple-owin">https://github.com/prabirshrestha/simple-owin</a></p>

<p>So we need to create a new class called <code>Startup</code> which contains a single method.</p>

<pre><code>namespace NancyOwinWeb
{
    using Owin;

    public class Startup
    {
        public void Configuration(IAppBuilder app)
        {
            app.UseNancy();
        }
    }
}
</code></pre>

<p>I opt to put this in a folder called App_Start</p>

<p><img src="/images/nancyfx-owin-5.png" alt="" /></p>

<p>That's really all that's required to setup Nancy in an Owin project. In the same configuration file you would obviously wire up other middleware, maybe some logging, possibly authentication, maybe... <em>shudder</em> you might even consider putting WebAPI in there. BUT please don't ruin your project :)</p>

<p>The namespace is pretty important, if you don't use the default namespace, the Microsoft.Owin host can't find the startup. If for example, we added the App_Start namespace to the class:</p>

<pre><code>namespace NancyOwinWeb.App_Start
{
    using Owin;

    public class Startup
    {
        public void Configuration(IAppBuilder app)
        {
            app.UseNancy();
        }
    }
}
</code></pre>

<p>We will get an exception thrown...</p>

<p><img src="/images/nancyfx-owin-8.png" alt="" /></p>

<p>Luckily if you run into this scenario, you can either fix the namespace, or add a appSetting to your web.config like so:</p>

<pre><code>&lt;add key="owin:AppStartup" value="NancyOwinWeb.App_Start.Startup, NancyOwinWeb" /&gt;
</code></pre>

<h2>Codez - Module</h2>

<p>Now we just need a module, so lets create a nice simple module</p>

<pre><code>namespace NancyOwinWeb.Modules
{
    using Nancy;

    public class HomeModule : NancyModule
    {
        public HomeModule()
        {
            Get["/"] = _ =&gt; "Hello from Owin!";
        }
    }
}
</code></pre>

<p>If we ran the app now this would happen...</p>

<p><img src="/images/nancyfx-owin-6.png" alt="" /></p>

<p>Nice! What about my Web.config file, that file that gets so messy that we all dread...</p>

<pre><code>&lt;?xml version="1.0"?&gt;

&lt;!--
  For more information on how to configure your ASP.NET application, please visit
  http://go.microsoft.com/fwlink/?LinkId=169433
--&gt;

&lt;configuration&gt;
    &lt;system.web&gt;
      &lt;compilation debug="true" targetFramework="4.5" /&gt;
      &lt;httpRuntime targetFramework="4.5" /&gt;
    &lt;/system.web&gt;   
&lt;/configuration&gt;
</code></pre>

<p>That's it, believe it or not, I haven't changed a single line of this file at all!</p>

<p>Best of all our references are next to nothing!</p>

<p><img src="/images/nancyfx-owin-7.png" alt="" /></p>

<p>So awesome...</p>


	<div class="divider"></div>
	<div id="disqus_thread"></div>
	<script>
	    var disqus_shortname = 'philliphaydon';
	    var disqus_url = "http://www.philliphaydon.com/2013/05/nancyfx-hosting-with-owin/";

	    /* * * DON'T EDIT BELOW THIS LINE * * */
	    (function () {
	        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
	        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	    })();
	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
	<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
    
	<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=undefined"></script>

</div>


                </div>
                <!-- #content -->
            </div>
            <!-- #primary .site-content -->

            <div id="secondary" class="widget-area fancy-container lightred" role="complementary">
                <aside id="text-5" class="widget widget_text">
                    <h1 class="widget-title">Follow</h1>
                    <div class="textwidget logos">
                        <a href="https://twitter.com/philliphaydon" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://twitter.com']);"><img src="/stylesheets/images/twitter.png"></a>
                        <a href="http://stackoverflow.com/users/456813/phill" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://stackoverflow.com']);"><img src="/stylesheets/images/stackoverflow.png"></a>
                        <a href="http://www.linkedin.com/in/philliphaydon" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://www.linkedin.com']);"><img src="/stylesheets/images/linkedin.png"></a>
                        <a href="https://plus.google.com/u/0/111751877537461442095" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://plus.google.com']);"><img src="/stylesheets/images/googleplus.png"></a>
                        <a href="https://coderbits.com/philliphaydon" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','https://coderbits.com/philliphaydon']);"><img src="/stylesheets/images/codebits.png"></a>
                        <a href="https://github.com/phillip-haydon" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://github.com']);"><img src="/stylesheets/images/github.png"></a>
                        <a href="http://www.codeschool.com/users/philliphaydon" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://codeschool.com']);"><img src="/stylesheets/images/codeschool.png"></a>
                        <a href="http://www.kickstarter.com/profile/phillip-haydon" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://kickstarter.com']);"><img src="/stylesheets/images/kickstarter.png"></a>
                    </div>
                    <a href="http://stackoverflow.com/users/456813/phill">
                      <img src="http://stackoverflow.com/users/flair/456813.png" width="208" height="58" alt="profile for Phill at Stack Overflow, Q&amp;A for professional and enthusiast programmers" title="profile for Phill at Stack Overflow, Q&amp;A for professional and enthusiast programmers">
                    </a>
                    
                    <a href="http://nancyfx.org/mvm.html"><img src="/stylesheets/images/mvm.png"></a>
                    
                    <div id = "clustrback" style="width:162px; height:133px;  background:#f7f7f7 url(http://clustrmaps.com/admin/3d/images/st4_grey.png)  center no-repeat; text-align:center;">
                      <a href="http://www2.clustrmaps.com/counter/maps.php?url=http://www.philliphaydon.com/" style="width:160px; display:block; margin:0 auto;" id="clustrMapsLink">
                        <img src="http://www2.clustrmaps.com/counter/index2.php?url=http://www.philliphaydon.com/" style="border:0px; margin:15px auto;margin:15px auto;" alt="Locations of visitors to this page" title="Locations of visitors to this page" id="clustrMapsImg" />
                      </a>
                    </div>
                </aside>
                <!--aside id="text-8" class="widget widget_text">
                    <h1 class="widget-title">Other sites</h1>
                    <div class="textwidget">
                        <a href="http://csharptube.com/" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://csharptube.com']);">csharptube.com</a><br />
                        <a href="http://thisisparrot.com/" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://thisisparrot.com']);">Parrot</a><br />
                        <a href="http://shitprogrammerswrite.com/" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://shitprogrammerswrite.com']);">Shit programmers write</a><br />
                    </div>
                </aside-->
                <aside id="linkcat-6" class="widget widget_links">
                    <h1 class="widget-title">Other Blogs</h1>
                    <ul class='xoxo blogroll'>
                        <li><a href="http://www.nickharris.net/" target="_top" onclick="javascript:_gaq.push(['_trackEvent','outbound-blogroll','http://nickharris.net/']);">Nick Harris</a></li>
                        <li><a href="http://www.mindscapehq.com/blog/" target="_top" onclick="javascript:_gaq.push(['_trackEvent','outbound-blogroll','http://www.mindscapehq.com/blog/']);">Mindscape</a></li>
                        <li><a href="http://blog.orangelightning.co.uk/" target="" onclick="javascript:_gaq.push(['_trackEvent','outbound-blogroll','http://blog.orangelightning.co.uk/']);">Phil Jones</a></li>
                        <li><a href="http://buildstarted.com/" target="" onclick="javascript:_gaq.push(['_trackEvent','outbound-blogroll','http://buildstarted.com']);">Ben Dornis</a></li>
                        <li><a href="http://jflood.net/" target="" onclick="javascript:_gaq.push(['_trackEvent','outbound-blogroll','http://jflood.net/']);">Jospeh Flood</a></li>
                    </ul>
                    
                </aside>
                <aside id="archives-4" class="widget widget_archive">
                    <h1 class="widget-title">Archive</h1>
                    
                    <ul class="posts">
                    
                          <li><a href="/archive#2013July">July, 2013</a></li>
                    
                          <li><a href="/archive#2013June">June, 2013</a></li>
                    
                          <li><a href="/archive#2013May">May, 2013</a></li>
                    
                          <li><a href="/archive#2013April">April, 2013</a></li>
                    
                          <li><a href="/archive#2013March">March, 2013</a></li>
                    
                          <li><a href="/archive#2013February">February, 2013</a></li>
                    
                          <li><a href="/archive#2013January">January, 2013</a></li>
                    
                          <li><a href="/archive#2012December">December, 2012</a></li>
                    
                          <li><a href="/archive#2012November">November, 2012</a></li>
                    
                          <li><a href="/archive#2012October">October, 2012</a></li>
                    
                          <li><a href="/archive#2012September">September, 2012</a></li>
                    
                          <li><a href="/archive#2012July">July, 2012</a></li>
                    
                          <li><a href="/archive#2012June">June, 2012</a></li>
                    
                          <li><a href="/archive#2012April">April, 2012</a></li>
                    
                          <li><a href="/archive#2012March">March, 2012</a></li>
                    
                          <li><a href="/archive#2012February">February, 2012</a></li>
                    
                          <li><a href="/archive#2012January">January, 2012</a></li>
                    
                          <li><a href="/archive#2011December">December, 2011</a></li>
                    
                          <li><a href="/archive#2011November">November, 2011</a></li>
                    
                          <li><a href="/archive#2011October">October, 2011</a></li>
                    
                          <li><a href="/archive#2011September">September, 2011</a></li>
                    
                          <li><a href="/archive#2011August">August, 2011</a></li>
                    
                          <li><a href="/archive#2011July">July, 2011</a></li>
                    
                          <li><a href="/archive#2011June">June, 2011</a></li>
                    
                          <li><a href="/archive#2011May">May, 2011</a></li>
                    
                          <li><a href="/archive#2011April">April, 2011</a></li>
                    
                          <li><a href="/archive#2011March">March, 2011</a></li>
                    
                          <li><a href="/archive#2011February">February, 2011</a></li>
                    
                          <li><a href="/archive#2011January">January, 2011</a></li>
                    
                          <li><a href="/archive#2010December">December, 2010</a></li>
                    
                          <li><a href="/archive#2010November">November, 2010</a></li>
                    
                          <li><a href="/archive#2010October">October, 2010</a></li>
                    
                          <li><a href="/archive#2010September">September, 2010</a></li>
                    
                          <li><a href="/archive#2009July">July, 2009</a></li>
                    
                    </ul>
                </aside>
            </div>
            <!-- #secondary .widget-area -->


        </div>
        <!-- #main -->

        <footer id="colophon" class="site-footer" role="contentinfo">
            <div class="site-info">
                Powered by <a href="https://github.com/Sandra/Sandra.Snow" rel="generator">Sandra.Snow</a>.	
            </div>
            <!-- .site-info -->
        </footer>
        <!-- #colophon .site-footer -->
    </div>
    <!-- #page .hfeed .site -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script src='/javascripts/prettify.js' type='text/javascript'></script>
    <!--script src='http://cdnjs.cloudflare.com/ajax/libs/prettify/188.0.0/prettify.js' type='text/javascript'></script-->
    <script type='text/javascript'>
      $(function () {
        $("pre code").parent().each(function () {
          if (!$(this).hasClass("prettyprint")) {
            $(this).addClass("prettyprint");
            a = true
          }
        });

        prettyPrint();
      });

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-655975-13']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
</body>
</html>
